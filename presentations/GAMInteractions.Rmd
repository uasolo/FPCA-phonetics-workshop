---
title: "Interactions between factors with GAMMs"
author: "Michele Gubian"
date: "March 11, 2022"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(magrittr)
library(mgcv)
library(itsadug)
library(emmeans)
library(RColorBrewer)
library(ggthemes)

State.colors <- colorblind_pal()(8)[c(1, 2, 6)]
```

## Example

Suppose we have realisations of a quantity `y` along the time axis. Each realisation has the form of a peak, and a `Category` with two levels, `low` and `high`, determines the general shape, i.e. a high/low peak. 
Suppose we run an experiment with participants going through 3 `States`: `BEFORE`, `DURING` and `AFTER` a certain experimental condition such as imitiation, altered auditory feedback, etc.. For simplicity we will not consider subject, item, trial, or any other factor usually modelled by random terms. We have a number of hypotheses:

1. `BEFORE`: `high` curves higher than `low` curves
2. `DURING`: `high` curves get lower than their level `BEFORE`, `low` curves get higher than their level `BEFORE`, i.e. they move towards each other
3. `DURING`: `high` curves remain higher than `low` curves, i.e. they do not cross
4. `DURING`: `high` curves move more towards `low` curves than vice versa
5. `AFTER` : `high` resp. `low` curves do not get lower resp. higher than their level `DURING`, i.e. the effect is over
6. `AFTER` : `high` resp. `low` curves do not get higher resp. lower than their level `BEFORE`, i.e. no overshoot

Below an illustration of the data set.

```{r echo=FALSE, message=FALSE}
# h(height), m(ean), s(t. dev.) of a Gaussian-like curve
# m_h = mean of height, s_m = st. dev. of mean, etc. 
m <- 1; s <- 1
s_h <- 0.05; s_m <- 0.05; s_s <- 0.1
s_e <- 0.2
t <- seq(0, 2, by = 0.01)
nCurvesXCell <- 50
curves <- tribble(
  ~Category, ~State, ~m_h, ~m_m, ~m_s,
  "low", "BEFORE", 1, m, s,
  "low", "DURING", 1.5, m, s,
  "low", "AFTER", 1.2, m, s,
  "high", "BEFORE", 3, m, s,
  "high", "DURING", 2, m, s,
  "high", "AFTER", 2.3, m, s
) %>%
  mutate(Category = factor(Category, levels = c("low", "high")),
         State = factor(State, levels = c("BEFORE", "DURING", "AFTER"))) %>%
  group_by(Category, State) %>%
  summarise(
    h = rnorm(nCurvesXCell, m_h, s_h),
    m = rnorm(nCurvesXCell, m_m, s_m),
    s = rnorm(nCurvesXCell, m_s, s_s)
  ) %>%
  mutate(trial = seq_len(n())) %>%
  group_by(across(everything())) %>%
  summarise(t = t,
            y = h * exp(-((t-m)/s)**2) + rnorm(length(t), 0, s_e)
            ) %>%
  ungroup()


curves %>% inner_join(curves %>% distinct(Category, State, trial) %>% slice_sample(n = 30)) %>%
ggplot() +
  aes(t, y, group = interaction(trial, State), color = State) +
  geom_line() +
  facet_grid(~ Category, labeller = label_both) +
  scale_color_manual(values = State.colors) +
  theme_light() +
  theme(text = element_text(size = 15), legend.position = "bottom")
  
```

We are going to test all the hypotheses. As comparison, for each hypothesis first we will select the time midpoint `t = 1`, build a clasic model with `lm` and test with `emmeans`. Then we show how to do this on the whole curve interval by building an appropriate GAM. 

### H1: `BEFORE`: `high` curves higher than `low` curves
Taking `t = 1` and using classic linear regression we obtain:

```{r}
mod1.lm <- lm(y ~ Category * State,
             data = curves %>% filter(t ==1))
emmeans(mod1.lm, pairwise ~ Category | State, at = list(State = "BEFORE"))
```
The difference between `high` and `low` at midpoint is significant and in the expected direction. 

With GAMs first need to need to create our own interaction term, as there is no way to express something like `Category * State` directly. Then we need to introduce convenient binary smooths that represent the smooth diffeences we are testing. 

The interaction term is created as follows:
```{r}
curves$CategoryState <- interaction(curves$Category, curves$State)
curves %>% distinct(CategoryState)
```

We then obtain smooth contrasts by creating one ordinary smooth per `State` and one corresponding binary
smooth representing the differnece between `high` and `low` at each `State`. 
The equation of the model is ($s =$ `State`, $c =$ `Category`, $l =$ `low`, $(B, D, A) =$ `(BEFORE, DURING, AFTER)`):

$$ y_i = \beta_0 + \sum_{s \in \{D, A\}} \beta_{s_i} \cdot I(s_i = s) + 
\sum_{s \in \{B, D, A\}} f_{s_i}(t_i) \cdot I(s_i = s) +
\sum_{s \in \{B, D, A\}} b_{s_i, h}(t_i) \cdot I(s_i = s \cap c = h) +
\epsilon_i
$$
Suppose a sample $i$ at time $t_i$ belongs to a curve of `Category` `low` ($c = l$) and `State` `BEFORE` ($s = B$). Then the the identity functions 'switch on' the following terms:

$$ y_i =  \beta_0 +  f_B(t_i) + \epsilon_i $$
while if `State == BEFORE` but `Category == high` 

$$ y_i =  \beta_0 +  f_B(t_i) + b_{B, h}(t_i) + \epsilon_i $$
and analogously for the other two states. This shows that the binary smooth $b_{B, h}(t_i)$ represents the difference between `high` and `low` for the `BEFORE` state. Remember that ordinary smooths like $f_B(t_i)$ are zero-centered, hence the whole effect is a combination of the intercept and the smooth itself. In this case, `BEFORE` is the control level for the intercept, thus only $\beta_0$ is present. On the contrary, binary terms are not zero-centered, hence $b_{B, h}(t_i)$ represents the whole difference `high - low` for the `BEFORE` `State`. 

The corresponding GAM is expressed using `mgcv` as:

```{r}
# create binary variables
curves$IsBEFORE_high <- 1 * (curves$CategoryState == "high.BEFORE")
curves$IsDURING_high <- 1 * (curves$CategoryState == "high.DURING")
curves$IsAFTER_high <- 1 * (curves$CategoryState == "high.AFTER")
mod1 <- bam(y ~ State + s(t, by = State) + s(t, by = IsBEFORE_high) + s(t, by = IsDURING_high) + + s(t, by = IsAFTER_high), data = curves)
summary(mod1)
```
